---
sidebar_position: 6
---

# 機械語

Nand2Tetrisの第4章をやる。この章では、Hackコンピュータの機械語についての紹介と、機械語に対応したアセンブリ言語が紹介される。

## 乗算(Mult.asm)

R0(RAM[0]とR1(RAM[1])に保存された値を取得し、R0 * R1 を実行。計算結果をR2(RAM[2])にいれるというもの。
HackのALUは掛け算には対応していないので、R0の値を愚直にR1回足すことで実現する。

上記を実現するアセンブリは以下である。　足すたびにnをインクリメントし、nがR1の値と一致するまでR0をR2に足し続ける

```asm
// This file is part of www.nand2tetris.org
// and the book "The Elements of Computing Systems"
// by Nisan and Schocken, MIT Press.
// File name: projects/4/Mult.asm

// Multiplies R0 and R1 and stores the result in R2.
// (R0, R1, R2 refer to RAM[0], RAM[1], and RAM[2], respectively.)
// The algorithm is based on repetitive addition.
    @n
    M=0
    @R2
    M=0
(LOOP)
    // if n==R1 goto END
    @n
    D=M
    @R1
    D=D-M
    @END
    D;JEQ

    // R2=R2+R0
    @R0
    D=M
    @R2
    M=D+M

    // n++
    @1
    D=A
    @n
    M=D+M
    @LOOP
    0;JMP

(END)
    @END
    0;JMP

```

上記をアセンブラでアセンブルすると、以下のようなHack機械語が出力される。

```
0000000000010000
1110101010001000
0000000000000010
1110101010001000
0000000000010000
1111110000010000
0000000000000001
1111010011010000
0000000000010100
1110001100000010
0000000000000000
1111110000010000
0000000000000010
1111000010001000
0000000000000001
1110110000010000
0000000000010000
1111000010001000
0000000000000100
1110101010000111
0000000000010100
1110101010000111
```


## 入出力操作(Fill.asm)

キーボードのいずれかのキーを押している最中は画面が黒くなっていき、何も押していないときは白くなるというもの。
1bitが1ピクセルに対応しており、CPUからは1ワードずつ(16bitずつ)アクセスできる。@SCREENのシンボルを使うことで、画面左上最初の1ワードに対応するアドレスを取得することができる。

これは以下のように実現する。
1. キーボードの押下のチェック
2. キーボードが押されている間は、1ワードずつ画面全体を黒くしていく(各ワードを1111111111111111にする)。キーボードが押されていない間は、1ワードずつ画面全体を白くしていく(各ワードを0000000000000000にする)。

また、画面は512 * 256ピクセル、つまり8192ワード（16384バイト）のRAMに対応しているので、全部塗りきったかどうかも確認するようにする。

```asm
// This file is part of www.nand2tetris.org
// and the book "The Elements of Computing Systems"
// by Nisan and Schocken, MIT Press.
// File name: projects/4/Fill.asm

// Runs an infinite loop that listens to the keyboard input. 
// When a key is pressed (any key), the program blackens the screen,
// i.e. writes "black" in every pixel. When no key is pressed, 
// the screen should be cleared.

(LOOP)
    @n
    M=0
    @KBD
    D=M
    @BLACK
    D;JGT
    @WHITE
    0;JMP

(BLACK)
    // 入力が消えていたらLOOPに移動
    @KBD
    D=M
    @LOOP
    D;JEQ

    // 全部ピクセルを黒く塗ったら終了
    @8192
    D=A
    @n
    D=M-D
    @LOOP
    D;JEQ
    
    @n
    D=M
    @SCREEN
    A=D+A
    M=-1 // 黒く塗る

    // n++
    @n
    M=M+1

    @BLACK
    0;JMP

(WHITE)
    // キーが押されていたらLOOPに移動
    @KBD
    D=M
    @LOOP
    D;JGT

    // 全部ピクセルを白く塗ったら終了
    @8192
    D=A
    @n
    D=M-D
    @LOOP
    D;JEQ

    @n
    D=M
    @SCREEN
    A=D+A
    M=0 // 白く塗る

    // n++
    @n
    M=M+1

    @WHITE
    0;JMP

```

アセンブルした結果は以下。

```asm
0000000000010000
1110101010001000
0110000000000000
1111110000010000
0000000000001000
1110001100000001
0000000000011011
1110101010000111
0110000000000000
1111110000010000
0000000000000000
1110001100000010
0010000000000000
1110110000010000
0000000000010000
1111000111010000
0000000000000000
1110001100000010
0000000000010000
1111110000010000
0100000000000000
1110000010100000
1110111010001000
0000000000010000
1111110111001000
0000000000001000
1110101010000111
0110000000000000
1111110000010000
0000000000000000
1110001100000001
0010000000000000
1110110000010000
0000000000010000
1111000111010000
0000000000000000
1110001100000010
0000000000010000
1111110000010000
0100000000000000
1110000010100000
1110101010001000
0000000000010000
1111110111001000
0000000000011011
1110101010000111
```